generator client {
  provider = "prisma-client-js"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Family Account - Conta compartilhada para m√∫ltiplos usu√°rios
model FamilyAccount {
  id        String   @id @default(cuid())
  name      String // Nome da conta (ex: "Casa", "Fam√≠lia")
  ownerId   String // ID do usu√°rio dono da conta
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users User[]

  @@index([id])
  @@index([ownerId])
}

// NextAuth Models
model User {
  id                  String            @id @default(cuid())
  name                String?
  email               String            @unique
  emailVerified       DateTime?
  image               String?           @db.MediumText
  password            String?
  familyAccountId     String? // ID da conta compartilhada
  familyAccount       FamilyAccount?    @relation(fields: [familyAccountId], references: [id], onDelete: SetNull)
  role                UserRole          @default(MEMBER) // N√≠vel de permiss√£o na conta familiar
  accounts            Account[]
  sessions            Session[]
  transactions        Transaction[]
  createdTransactions Transaction[]     @relation("TransactionCreator")
  subscriptions       Subscription[]
  notifications       Notification[]
  bankAccounts        BankAccount[]
  userSettings        UserSettings?
  goals               Goal[]
  financialProfile    FinancialProfile?
  projects            Project[]
  workPeriods         WorkPeriod[]
  workGoal            UserGoal?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
}

model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
}

model Transaction {
  id                 String                   @id @default(uuid())
  name               String
  type               TransactionType
  amount             Float
  category           TransactionCategory
  paymentMethod      TransactionPaymentMethod
  createdAt          DateTime                 @default(now())
  updatedAt          DateTime                 @updatedAt
  userId             String // Usu√°rio da conta (para filtros)
  user               User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdByUserId    String // Usu√°rio que criou a transa√ß√£o
  createdBy          User                     @relation("TransactionCreator", fields: [createdByUserId], references: [id], onDelete: Cascade)
  date               DateTime?
  installments       Int? // Total de parcelas (ex: 12)
  currentInstallment Int? // Parcela atual (ex: 1)
  installmentGroupId String? // ID para agrupar parcelas da mesma compra
  bankAccountId      String? // Conta/Cart√£o vinculado √† transa√ß√£o
  bankAccount        BankAccount?             @relation(fields: [bankAccountId], references: [id], onDelete: SetNull)
  icon               String? // √çcone/emoji da transa√ß√£o

  @@index([userId])
  @@index([createdByUserId])
  @@index([installmentGroupId])
  @@index([bankAccountId])
}

enum TransactionType {
  DEPOSIT
  EXPENSE
  INVESTMENT
}

enum TransactionCategory {
  HOUSING
  TRANSPORTATION
  FOOD
  ENTERTAINMENT
  HEALTH
  UTILITY
  SALARY
  EDUCATION
  OTHER
}

enum TransactionPaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  BANK_TRANSFER
  BANK_SLIP
  CASH
  PIX
  BENEFIT
  OTHER
}

// Subscription Management
model Subscription {
  id          String    @id @default(cuid())
  userId      String
  name        String
  logoUrl     String?
  amount      Float
  dueDate     DateTime
  recurring   Boolean   @default(true)
  nextDueDate DateTime?
  active      Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([nextDueDate])
  @@index([active])
}

// Notifications System
model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String           @db.Text
  read      Boolean          @default(false)
  meta      Json?
  createdAt DateTime         @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
}

enum NotificationType {
  SUBSCRIPTION_DUE
  AI_INSIGHT
  TRANSACTION_ALERT
  SYSTEM
}

// Bank Accounts - Contas Banc√°rias Vinculadas
model BankAccount {
  id          String          @id @default(cuid())
  userId      String
  name        String // Nome da conta (ex: "Conta Corrente Nubank")
  bankName    String // Nome do banco (ex: "Nubank", "Ita√∫")
  accountType BankAccountType
  balance     Float           @default(0)
  isActive    Boolean         @default(true)
  color       String? // Cor para identifica√ß√£o visual
  icon        String? // √çcone/emoji para identifica√ß√£o
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@index([userId])
  @@index([isActive])
}

enum BankAccountType {
  CHECKING_ACCOUNT // Conta Corrente
  SAVINGS_ACCOUNT // Poupan√ßa
  INVESTMENT_ACCOUNT // Conta de Investimento
  CREDIT_CARD // Cart√£o de Cr√©dito
  OTHER // Outro
}

// User Settings - Configura√ß√µes individuais do usu√°rio
model UserSettings {
  id                 String   @id @default(cuid())
  userId             String   @unique
  userTitle          String? // T√≠tulo personalizado exibido na sidebar (ex: "Gerente Financeiro")
  hfApiKey           String?  @db.Text // Chave da API Hugging Face
  closingDay         Int?     @default(5) // Dia de fechamento
  emailNotifications Boolean  @default(true)
  subscriptionAlerts Boolean  @default(true)
  transactionAlerts  Boolean  @default(false)
  aiInsights         Boolean  @default(true)
  categoryIcons      Json? // √çcones personalizados por categoria: { "FOOD": "üçî", "TRANSPORTATION": "üöó", ... }
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// Financial Profile - Perfil Financeiro do Usu√°rio
model FinancialProfile {
  id                 String   @id @default(cuid())
  userId             String   @unique
  rendaFixa          Float    @default(0)
  rendaVariavelMedia Float    @default(0)
  beneficios         Json     @default("[]") // Array de benef√≠cios: [{"type":"VR","value":350.00,"notes":"Vale refei√ß√£o","category":"Alimenta√ß√£o"}]
  diaPagamento       Int? // Dia √∫nico de pagamento (1-31)
  multiplePayments   Json? // M√∫ltiplos pagamentos: [{"label":"Sal√°rio","day":5,"value":3000.00}]
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// Goals - Metas Financeiras
model Goal {
  id            String       @id @default(cuid())
  userId        String
  name          String
  description   String?      @db.Text
  targetAmount  Float
  currentAmount Float        @default(0)
  deadline      DateTime
  category      GoalCategory
  status        GoalStatus   @default(ACTIVE)
  icon          String? // √çcone/emoji para identifica√ß√£o
  color         String? // Cor para identifica√ß√£o visual
  isShared      Boolean      @default(false) // Meta conjunta
  sharedWith    Json?        @default("[]") // Array de user_ids: ["user1", "user2"]
  ownerUserId   String? // ID do usu√°rio dono da meta (quando compartilhada)
  contributions Json?        @default("[]") // Hist√≥rico de contribui√ß√µes: [{"userId":"id","amount":100,"date":"2025-01-01T00:00:00.000Z"}]
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([deadline])
  @@index([isShared])
  @@index([ownerUserId])
}

enum GoalCategory {
  SAVINGS // Poupan√ßa
  INVESTMENT // Investimento
  EMERGENCY // Reserva de Emerg√™ncia
  VACATION // Viagem/F√©rias
  HOUSE // Casa/Im√≥vel
  VEHICLE // Ve√≠culo
  EDUCATION // Educa√ß√£o
  WEDDING // Casamento
  OTHER // Outro
}

enum GoalStatus {
  ACTIVE // Ativa
  COMPLETED // Conclu√≠da
  CANCELLED // Cancelada
  PAUSED // Pausada
}

enum UserRole {
  OWNER // Dono da conta - pode fazer tudo
  ADMIN // Administrador - pode gerenciar usu√°rios (exceto dono)
  MEMBER // Membro - usu√°rio comum, n√£o pode editar outros usu√°rios
}

// Project - Projetos/Clientes para Freelancers
model Project {
  id          String        @id @default(cuid())
  userId      String
  clientName  String // Nome do cliente
  projectName String? // Nome do projeto (opcional)
  hourlyRate  Float? // Valor por hora de refer√™ncia (opcional)
  status      ProjectStatus @default(ACTIVE)
  notes       String?       @db.Text
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  user    User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  periods WorkPeriod[]

  @@index([userId])
  @@index([status])
}

enum ProjectStatus {
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

// WorkPeriod - Per√≠odos de Trabalho para Freelancers
model WorkPeriod {
  id          String   @id @default(cuid())
  userId      String
  projectId   String? // Opcional - pode trabalhar sem projeto
  date        DateTime // Data do servi√ßo
  startTime   DateTime // Hor√°rio de in√≠cio
  endTime     DateTime // Hor√°rio de fim
  hours       Float // Calculado automaticamente (em horas decimais)
  amount      Float // Valor recebido neste per√≠odo
  expenses    Float    @default(0) // Despesas deste per√≠odo
  netProfit   Float // Calculado: amount - expenses
  description String?  @db.Text // O que foi feito
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([date])
  @@index([projectId])
}

// UserGoal - Metas de trabalho para freelancers
model UserGoal {
  id          String   @id @default(cuid())
  userId      String   @unique
  goalType    String   @default("monthly") // "daily", "weekly", "monthly", "custom"
  dailyGoal   Float? // Meta di√°ria (opcional)
  weeklyGoal  Float? // Meta semanal (opcional)
  monthlyGoal Float? // Meta mensal (opcional)
  customGoal  Float? // Meta personalizada (opcional)
  customStartDate DateTime? // Data inicial da meta personalizada
  customEndDate   DateTime? // Data final da meta personalizada
  maxHoursDay Float? // Horas m√°ximas por dia (opcional)
  workDays    String   @default("1,2,3,4,5,6,7") // Dias dispon√≠veis: 1=domingo, 2=segunda, ..., 7=s√°bado
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}
